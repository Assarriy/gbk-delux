<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GBK Online: Ultra Deluxe Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        :root {
            --neon-color: #00f2ff;
            --galaxy-color: #7d00ff;
            --gold-color: #fbbf24;
            --divine-color: #ffffff;
            --cyber-color: #39ff14;
            --primary-accent: #4f46e5;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --bg-gradient: radial-gradient(circle at top left, #020617, #0f172a, #1e1b4b);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            transition: all 1s ease;
        }

        /* --- LAYERING --- */
        .theme-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; overflow: hidden; }
        .cyber-grid { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px; pointer-events: none; z-index: -1; 
        }

        /* --- THEMES --- */
        body.theme-cyberpunk { --bg-gradient: linear-gradient(135deg, #050505, #120520, #051515); --primary-accent: #ff00ff; }
        body.theme-cyberpunk .cyber-grid { display: block; animation: gridSlide 20s linear infinite; }
        @keyframes gridSlide { from { background-position: 0 0; } to { background-position: 40px 40px; } }
        
        body.theme-sakura { --bg-gradient: radial-gradient(circle, #3d1425, #1a0a1a); --primary-accent: #f472b6; }
        body.theme-ocean { --bg-gradient: linear-gradient(180deg, #041d20, #000000); --primary-accent: #0ea5e9; }
        body.theme-magma { --bg-gradient: radial-gradient(circle, #300505, #000000); --primary-accent: #ef4444; }

        /* --- UI ELEMENTS --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-view { animation: slideIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .btn-choice {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; z-index: 10;
        }
        .btn-choice:hover:not(:disabled) { transform: translateY(-8px) scale(1.05); filter: brightness(1.2); }
        .choice-selected { background: var(--primary-accent) !important; border-color: white !important; box-shadow: 0 0 30px var(--primary-accent); transform: scale(1.1); }

        /* --- SKIN EFFECTS --- */
        .effect-base { position: relative !important; overflow: hidden !important; }
        .effect-neon { animation: neonFlicker 2s infinite; border: 2px solid var(--neon-color) !important; }
        @keyframes neonFlicker { 0%, 100% { opacity: 1; box-shadow: 0 0 20px var(--neon-color); } 50% { opacity: 0.8; box-shadow: 0 0 10px var(--neon-color); } }
        
        .effect-galaxy { background: linear-gradient(45deg, #0f0c29, #302b63, #24243e) !important; border: 2px solid #a855f7 !important; box-shadow: 0 0 30px #a855f7; }
        .effect-gold { background: linear-gradient(135deg, #ffd700, #b8860b) !important; border: 2px solid #fff !important; box-shadow: 0 0 30px #fbbf24; color: #000 !important; }
        
        .effect-divine {
            background: linear-gradient(135deg, #ffffff, #e0e7ff) !important;
            color: #1e1b4b !important; border: 3px solid #fff !important;
            box-shadow: 0 0 40px #fff; animation: float 3s infinite ease-in-out;
        }

        .effect-cyber { background: #000 !important; border: 2px solid #39ff14 !important; box-shadow: 0 0 15px #39ff14; }

        /* LABELS CONTRAST FIX */
        .choice-label {
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em;
            margin-top: 10px; padding: 4px 12px; border-radius: 8px;
            background: rgba(0,0,0,0.8); color: white;
        }
        .divine-label-fix { background: #4338ca !important; color: #fff !important; border: 1px solid white; }
        .gold-label-fix { background: #000 !important; color: #ffd700 !important; border: 1px solid #ffd700; }

        /* PARTICLES */
        .particle { position: absolute; pointer-events: none; z-index: 2; }
        .sakura-petal { background: #f472b6; border-radius: 100% 0 100% 0; animation: fall linear infinite; }
        .ocean-bubble { background: rgba(255,255,255,0.2); border-radius: 50%; animation: rise linear infinite; }
        .magma-ember { background: #ef4444; border-radius: 2px; box-shadow: 0 0 10px #ef4444; animation: rise linear infinite; }

        @keyframes fall { from { transform: translateY(-5vh) rotate(0deg); } to { transform: translateY(105vh) rotate(360deg); } }
        @keyframes rise { from { transform: translateY(105vh); opacity: 1; } to { transform: translateY(-5vh); opacity: 0; } }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div id="theme-overlay" class="theme-overlay"></div>
    <div class="cyber-grid"></div>

    <div id="app" class="w-full max-w-md relative z-10">
        <!-- Auth Screen -->
        <div id="auth-screen" class="glass p-8 rounded-[3rem] text-center animate-view">
            <div class="mb-8">
                <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl rotate-12 transition-transform hover:rotate-0">
                    <i class="fas fa-hand-fist text-5xl text-white"></i>
                </div>
                <h1 class="text-5xl font-black tracking-tighter mb-2 italic">GBK <span class="text-indigo-400">DELUXE</span></h1>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-[0.3em]">Multiplayer Arena</p>
            </div>
            <div class="space-y-5">
                <div class="text-left">
                    <label class="text-[10px] uppercase font-black text-indigo-400 mb-2 block ml-2">Username</label>
                    <input type="text" id="username-input" placeholder="NAMA..." class="w-full px-6 py-4 rounded-2xl bg-white/5 border border-white/10 focus:border-indigo-500 focus:outline-none text-center text-lg font-bold uppercase text-white">
                </div>
                <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition-all uppercase tracking-widest">MASUK</button>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mode-screen" class="hidden glass p-8 rounded-[3rem] text-center animate-view">
            <div class="flex justify-between items-center mb-8">
                <div id="display-name-container" class="flex flex-col items-start gap-1"></div>
                <div class="bg-black/30 px-4 py-2 rounded-xl border border-white/10 flex items-center gap-2">
                    <i class="fas fa-coins text-amber-400"></i>
                    <span id="user-coins" class="font-black text-xl text-white">0</span>
                </div>
            </div>
            <div class="grid gap-4">
                <button onclick="goToRounds('pvai')" class="glass p-5 rounded-2xl flex items-center gap-5 text-left border-white/5 hover:border-indigo-500/50 transition-all group">
                    <div class="w-14 h-14 bg-indigo-500 rounded-xl flex items-center justify-center text-3xl shadow-lg text-white"><i class="fas fa-robot"></i></div>
                    <div><h3 class="font-bold text-lg">Latihan Bot</h3><p class="text-[10px] text-slate-400 uppercase font-bold">Kumpulkan Koin</p></div>
                </button>
                <button onclick="goToRounds('pvp')" class="glass p-5 rounded-2xl flex items-center gap-5 text-left border-white/5 hover:border-indigo-500/50 transition-all group">
                    <div class="w-14 h-14 bg-purple-600 rounded-xl flex items-center justify-center text-3xl shadow-lg text-white"><i class="fas fa-globe"></i></div>
                    <div><h3 class="font-bold text-lg">Duel Online</h3><p class="text-[10px] text-slate-400 uppercase font-bold">Multiplayer</p></div>
                </button>
                <button onclick="showShop()" class="glass p-5 rounded-2xl flex items-center gap-5 text-left border-white/5 hover:border-indigo-500/50 transition-all group">
                    <div class="w-14 h-14 bg-amber-500 rounded-xl flex items-center justify-center text-3xl shadow-lg text-white"><i class="fas fa-crown"></i></div>
                    <div><h3 class="font-bold text-lg">Butik</h3><p class="text-[10px] text-slate-400 uppercase font-bold">Skin & Tema</p></div>
                </button>
                <button id="logout-btn" class="mt-4 text-slate-500 text-xs font-bold uppercase tracking-widest">LOGOUT</button>
            </div>
        </div>

        <!-- Arena -->
        <div id="game-screen" class="hidden w-full animate-view">
            <div class="glass p-5 rounded-[3rem] space-y-8 relative overflow-hidden">
                <!-- Score Header -->
                <div class="flex justify-between items-center bg-black/20 p-4 rounded-2xl border border-white/5">
                    <div class="text-center flex-1"><div id="p1-name-wrapper" class="text-xs font-bold mb-1"></div><div id="p1-score" class="text-4xl font-black text-indigo-400">0</div></div>
                    <div class="px-2 text-center">
                        <div id="current-bet-display" class="hidden text-[9px] text-amber-400 font-bold uppercase mb-1">Bet: 0</div>
                        <div class="bg-indigo-600 px-3 py-1 rounded-full text-[9px] font-black text-white" id="current-round-display">1 / 3</div>
                    </div>
                    <div class="text-center flex-1"><div id="p2-name-wrapper" class="text-xs font-bold mb-1"></div><div id="p2-score" class="text-4xl font-black text-purple-400">0</div></div>
                </div>

                <!-- Battle Area -->
                <div class="flex justify-center items-center gap-4 py-2">
                    <div class="flex flex-col items-center flex-1">
                        <div id="p1-display" class="w-24 h-24 bg-white/5 rounded-3xl flex items-center justify-center text-6xl border border-white/10 transition-all effect-base"><i class="fas fa-question text-white/5"></i></div>
                        <div id="p1-choice-label" class="choice-label"></div>
                    </div>
                    <div class="text-xl font-black opacity-20 italic">VS</div>
                    <div class="flex flex-col items-center flex-1">
                        <div id="p2-display" class="w-24 h-24 bg-white/5 rounded-3xl flex items-center justify-center text-6xl border border-white/10 transition-all effect-base"><i class="fas fa-question text-white/5"></i></div>
                        <div id="p2-choice-label" class="choice-label"></div>
                    </div>
                </div>

                <div id="game-message" class="text-center min-h-[60px] flex flex-col items-center justify-center font-black italic text-sm">
                    <p class="text-slate-500 uppercase tracking-widest">Menunggu Serangan...</p>
                </div>

                <!-- Controls -->
                <div id="game-controls" class="grid grid-cols-3 gap-4 p-2 bg-black/10 rounded-[2rem]">
                    <button id="btn-batu" onclick="makeChoice('batu')" class="btn-choice aspect-square rounded-2xl flex flex-col items-center justify-center border border-white/5 bg-white/5">
                        <span id="skin-batu" class="text-4xl mb-1"></span><span class="text-[8px] font-bold uppercase opacity-50">Batu</span>
                    </button>
                    <button id="btn-kertas" onclick="makeChoice('kertas')" class="btn-choice aspect-square rounded-2xl flex flex-col items-center justify-center border border-white/5 bg-white/5">
                        <span id="skin-kertas" class="text-4xl mb-1"></span><span class="text-[8px] font-bold uppercase opacity-50">Kertas</span>
                    </button>
                    <button id="btn-gunting" onclick="makeChoice('gunting')" class="btn-choice aspect-square rounded-2xl flex flex-col items-center justify-center border border-white/5 bg-white/5">
                        <span id="skin-gunting" class="text-4xl mb-1"></span><span class="text-[8px] font-bold uppercase opacity-50">Gunting</span>
                    </button>
                </div>

                <div id="game-actions" class="hidden space-y-3">
                    <button id="next-round-btn" class="w-full bg-indigo-600 py-5 rounded-2xl font-black uppercase text-white shadow-lg">Lanjut Babak</button>
                    <button id="final-rematch-btn" class="hidden w-full bg-indigo-600 py-5 rounded-2xl font-black uppercase text-white">Main Lagi</button>
                    <button id="quit-btn" class="w-full text-slate-500 text-[10px] font-bold uppercase">Lobby</button>
                </div>
            </div>
        </div>

        <!-- Shop Screen -->
        <div id="shop-screen" class="hidden glass p-8 rounded-[3rem] animate-view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black italic uppercase">Butik</h2>
                <div class="bg-black/30 px-3 py-1 rounded-xl flex items-center gap-2">
                    <i class="fas fa-coins text-amber-400"></i><span id="shop-coins" class="font-black">0</span>
                </div>
            </div>
            <div class="flex gap-2 mb-6">
                <button id="tab-icons" onclick="renderShop('icons')" class="flex-1 py-3 rounded-xl bg-indigo-600 font-bold text-[10px] uppercase text-white">Skin Ikon</button>
                <button id="tab-themes" onclick="renderShop('themes')" class="flex-1 py-3 rounded-xl bg-white/5 font-bold text-[10px] uppercase">Tema UI</button>
            </div>
            <div id="skin-list" class="grid gap-3 max-h-[350px] overflow-y-auto pr-2 custom-scrollbar"></div>
            <button onclick="showScreen('mode')" class="w-full mt-6 bg-indigo-600 py-4 rounded-2xl font-black uppercase text-sm">Kembali</button>
        </div>

        <!-- Helper Screens -->
        <div id="round-screen" class="hidden glass p-8 rounded-[3rem] text-center">
            <h2 class="text-2xl font-black mb-8 uppercase">Jumlah Babak</h2>
            <div class="grid gap-4">
                <button onclick="selectRounds(3)" class="glass p-5 rounded-xl font-black text-xl hover:border-indigo-500">3 Babak</button>
                <button onclick="selectRounds(5)" class="glass p-5 rounded-xl font-black text-xl hover:border-indigo-500">5 Babak</button>
                <button onclick="selectRounds(10)" class="glass p-5 rounded-xl font-black text-xl hover:border-indigo-500">10 Babak</button>
            </div>
            <button onclick="showScreen('mode')" class="mt-6 text-slate-500 text-xs">BATAL</button>
        </div>

        <div id="pvp-menu-screen" class="hidden glass p-8 rounded-[3rem] text-center">
            <h2 class="text-3xl font-black mb-8 uppercase">Arena PvP</h2>
            <div class="space-y-6">
                <div class="bg-indigo-900/20 p-6 rounded-2xl">
                    <label class="text-[10px] font-black text-indigo-400 block mb-2 uppercase">Taruhan</label>
                    <input type="number" id="bet-input" value="0" min="0" step="50" class="bg-transparent border-none text-center text-4xl font-black text-white focus:outline-none w-full">
                </div>
                <button onclick="createRoom()" class="w-full bg-indigo-600 py-5 rounded-2xl font-black uppercase">Buat Room</button>
                <input type="text" id="join-id-input" placeholder="KODE ROOM" class="w-full px-6 py-4 rounded-2xl bg-white/5 border border-white/10 text-center text-xl font-mono font-black uppercase focus:border-indigo-500 text-white">
                <button onclick="joinRoom()" class="w-full bg-purple-600 py-5 rounded-2xl font-black uppercase">Gabung</button>
                <button onclick="showScreen('round')" class="text-slate-500 text-xs">Kembali</button>
            </div>
        </div>

        <div id="waiting-screen" class="hidden glass p-8 rounded-[3rem] text-center">
            <h3 class="text-indigo-400 text-[10px] font-black uppercase mb-4">Membagikan Kode</h3>
            <div class="text-6xl font-black tracking-widest mb-10 bg-black/20 py-8 rounded-3xl border border-white/10" id="lobby-id-display">00000</div>
            <div class="flex justify-center gap-3 mb-10">
                <div class="bg-indigo-500/20 px-4 py-2 rounded-full text-[10px] font-black uppercase" id="lobby-round-info"></div>
                <div class="bg-amber-400/20 px-4 py-2 rounded-full text-[10px] font-black uppercase text-amber-400" id="lobby-bet-info"></div>
            </div>
            <button id="cancel-room-btn" class="text-red-500 text-xs font-black">BATALKAN</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDqC9Ok6wZTaERThiES3dGkRdFSlW04mEo",
            authDomain: "gbk-delux.firebaseapp.com",
            projectId: "gbk-delux",
            storageBucket: "gbk-delux.firebasestorage.app",
            messagingSenderId: "344892094742",
            appId: "1:344892094742:web:c7a39bc3376dbb4de53837",
            measurementId: "G-1961BQK0P4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'gbk-deluxe-v3-stable';

        let currentUser = null;
        let userData = { username: "", tag: "", coins: 0, skins: ["default"], themes: ["default"], activeSkin: "default", activeTheme: "default" };
        let currentGameId = null;
        let isPlayer1 = true;
        let gameMode = 'pvp'; 
        let selectedMaxRounds = 3;
        let gameListener = null;

        const SKIN_SETS = {
            'default': { batu: 'âœŠ', kertas: 'âœ‹', gunting: 'âœŒï¸', price: 0, class: 'effect-base', rarity: 'Common' },
            'fruit': { batu: 'ðŸŽ', kertas: 'ðŸŒ', gunting: 'ðŸ‡', price: 150, class: 'effect-fruit effect-base', rarity: 'Common' },
            'neon': { batu: 'ðŸ”¥', kertas: 'â„ï¸', gunting: 'âš¡', price: 400, class: 'effect-neon effect-base', rarity: 'Rare' },
            'animal': { batu: 'ðŸ¦', kertas: 'ðŸ¢', gunting: 'ðŸ¦…', price: 600, class: 'effect-animal effect-base', rarity: 'Rare' },
            'cyber': { batu: 'ðŸ‘¾', kertas: 'ðŸ“¡', gunting: 'âš”ï¸', price: 800, class: 'effect-cyber effect-base', rarity: 'Rare' },
            'galaxy': { batu: 'ðŸŒ‘', kertas: 'ðŸª', gunting: 'â­', price: 1500, class: 'effect-galaxy effect-base', rarity: 'Epic' },
            'divine': { batu: 'ðŸ”±', kertas: 'ðŸ•Šï¸', gunting: 'âš¡', price: 3000, class: 'effect-divine effect-base', rarity: 'Epic' },
            'gold': { batu: 'ðŸ’°', kertas: 'ðŸ’Ž', gunting: 'ðŸ”±', price: 5000, class: 'effect-gold effect-base', rarity: 'Legendary' }
        };

        const THEME_SETS = {
            'default': { name: 'Dark Void', price: 0, class: '', rarity: 'Common' },
            'cyberpunk': { name: 'Cyber Neon', price: 1000, class: 'theme-cyberpunk', rarity: 'Rare' },
            'sakura': { name: 'Zen Sakura', price: 1000, class: 'theme-sakura', rarity: 'Rare' },
            'ocean': { name: 'Deep Ocean', price: 1000, class: 'theme-ocean', rarity: 'Rare' },
            'magma': { name: 'Hell Magma', price: 2000, class: 'theme-magma', rarity: 'Epic' }
        };

        const screens = { auth: document.getElementById('auth-screen'), mode: document.getElementById('mode-screen'), shop: document.getElementById('shop-screen'), round: document.getElementById('round-screen'), pvpMenu: document.getElementById('pvp-menu-screen'), waiting: document.getElementById('waiting-screen'), game: document.getElementById('game-screen') };

        window.showScreen = (screenId) => { Object.values(screens).forEach(s => s.classList.add('hidden')); if(screens[screenId]) screens[screenId].classList.remove('hidden'); };

        onAuthStateChanged(auth, async (user) => { 
            if (user) { 
                currentUser = user; 
            } else { 
                signInAnonymously(auth); 
            } 
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            let input = document.getElementById('username-input').value.trim().toUpperCase();
            if (!input) return;
            const codes = { "081249781394": "ADMIN", "0812VIP": "VIP", "0812PRO": "PRO" };
            let tag = ""; let finalName = input;
            for (const [code, tagName] of Object.entries(codes)) { if (input.startsWith(code)) { tag = tagName; finalName = input.replace(code, "").trim() || "ADMIN_USER"; break; } }

            const userDocRef = doc(db, 'users', finalName);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                const data = userDoc.data();
                userData = { ...userData, ...data, skins: data.skins || ["default"], themes: data.themes || ["default"], activeSkin: data.activeSkin || "default", activeTheme: data.activeTheme || "default", coins: data.coins || 0 };
            } else {
                userData = { username: finalName, tag: tag, coins: tag === 'ADMIN' ? 999999999 : 500, skins: ["default"], themes: ["default"], activeSkin: "default", activeTheme: "default", lastSeen: Date.now() };
                await setDoc(userDocRef, userData);
            }
            if (tag === 'ADMIN') { userData.tag = tag; userData.coins = 999999999; }
            applyTheme(userData.activeTheme);
            updateUserUI(); showScreen('mode');
        });

        document.getElementById('logout-btn').addEventListener('click', async () => { try { if (gameListener) gameListener(); await signOut(auth); window.location.reload(); } catch (e) { console.error(e); } });

        function applyTheme(themeId) { 
            const overlay = document.getElementById('theme-overlay');
            overlay.innerHTML = '';
            document.body.className = "flex items-center justify-center p-4 " + (THEME_SETS[themeId]?.class || '');
            
            const pCount = themeId === 'default' ? 0 : 20;
            const pClass = themeId === 'sakura' ? 'sakura-petal' : (themeId === 'ocean' ? 'ocean-bubble' : 'magma-ember');
            
            if (pCount > 0) {
                for(let i=0; i<pCount; i++) {
                    const p = document.createElement('div');
                    p.className = `particle ${pClass}`;
                    const size = Math.random() * 15 + 5;
                    p.style.width = size + 'px';
                    p.style.height = (themeId === 'sakura' ? size * 0.8 : size) + 'px';
                    p.style.left = Math.random() * 100 + 'vw';
                    p.style.animationDuration = (Math.random() * 5 + 5) + 's';
                    p.style.animationDelay = Math.random() * 5 + 's';
                    overlay.appendChild(p);
                }
            }
        }

        function getTagHtml(tag, extraClass = "") { if (!tag) return ''; const tagLower = tag.toLowerCase(); return `<span class="tag-base tag-${tagLower} ${extraClass}">${tag}</span>`; }

        function updateUserUI() {
            const container = document.getElementById('display-name-container');
            const getTag = (t) => t ? `<span class="tag-base tag-${t.toLowerCase()} mb-1 text-white">${t}</span>` : '';
            container.innerHTML = `${getTag(userData.tag)}<span class="font-black text-white text-2xl uppercase tracking-tighter italic">${userData.username}</span>`;
            document.getElementById('user-coins').textContent = userData.tag === 'ADMIN' ? 'âˆž' : (userData.coins || 0).toLocaleString();
            document.getElementById('shop-coins').textContent = userData.tag === 'ADMIN' ? 'âˆž' : (userData.coins || 0).toLocaleString();
            applySkinToControls();
        }

        function applySkinToControls() {
            const skin = SKIN_SETS[userData.activeSkin || 'default'];
            document.getElementById('skin-batu').textContent = skin.batu;
            document.getElementById('skin-kertas').textContent = skin.kertas;
            document.getElementById('skin-gunting').textContent = skin.gunting;
            ['btn-batu', 'btn-kertas', 'btn-gunting'].forEach(id => {
                const btn = document.getElementById(id);
                btn.className = `btn-choice aspect-square rounded-[2rem] flex flex-col items-center justify-center border border-white/5 bg-white/5 text-white ${skin.class}`;
            });
        }

        window.renderShop = (type) => {
            const list = document.getElementById('skin-list'); list.innerHTML = '';
            const btnIcons = document.getElementById('tab-icons');
            const btnThemes = document.getElementById('tab-themes');
            
            btnIcons.className = type === 'icons' ? 'flex-1 py-3 rounded-xl bg-indigo-600 font-bold text-[10px] uppercase text-white' : 'flex-1 py-3 rounded-xl bg-white/5 font-bold text-[10px] uppercase text-slate-400';
            btnThemes.className = type === 'themes' ? 'flex-1 py-3 rounded-xl bg-indigo-600 font-bold text-[10px] uppercase text-white' : 'flex-1 py-3 rounded-xl bg-white/5 font-bold text-[10px] uppercase text-slate-400';

            if (type === 'icons') {
                Object.entries(SKIN_SETS).forEach(([id, set]) => {
                    const isOwned = (userData.skins || ["default"]).includes(id);
                    const isActive = userData.activeSkin === id;
                    const card = document.createElement('div');
                    card.className = `glass p-4 rounded-3xl flex items-center justify-between border transition-all ${isActive ? 'border-indigo-500 bg-indigo-500/10' : 'border-white/5'}`;
                    card.innerHTML = `
                        <div class="flex items-center gap-4"><div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center text-4xl ${set.class}">${set.batu}</div><div class="text-left"><span class="rarity-tag rarity-${set.rarity.toLowerCase()}">${set.rarity}</span><h3 class="font-black text-lg uppercase mt-1">${id}</h3></div></div>
                        <div class="text-right">
                            ${isOwned ? `<button onclick="equipItem('skin', '${id}')" class="px-6 py-2 ${isActive ? 'bg-indigo-500 text-white' : 'bg-white/10 text-slate-400'} rounded-xl text-[10px] font-black uppercase">${isActive ? 'AKTIF' : 'PAKAI'}</button>` :
                            `<button onclick="buyItem('skin', '${id}', ${set.price})" class="px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-black text-black"><i class="fas fa-coins text-[8px]"></i> ${set.price.toLocaleString()}</button>`}
                        </div>`;
                    list.appendChild(card);
                });
            } else {
                Object.entries(THEME_SETS).forEach(([id, set]) => {
                    const isOwned = (userData.themes || ["default"]).includes(id);
                    const isActive = userData.activeTheme === id;
                    const card = document.createElement('div');
                    card.className = `glass p-4 rounded-3xl flex items-center justify-between border transition-all ${isActive ? 'border-indigo-500 bg-indigo-500/10' : 'border-white/5'}`;
                    card.innerHTML = `
                        <div class="flex items-center gap-4"><div class="w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center"><i class="fas fa-palette text-2xl text-indigo-400"></i></div><div class="text-left"><span class="rarity-tag rarity-${set.rarity.toLowerCase()}">${set.rarity}</span><h3 class="font-black text-lg uppercase mt-1">${set.name}</h3></div></div>
                        <div class="text-right">
                            ${isOwned ? `<button onclick="equipItem('theme', '${id}')" class="px-6 py-2 ${isActive ? 'bg-indigo-500 text-white' : 'bg-white/10 text-slate-400'} rounded-xl text-[10px] font-black uppercase">${isActive ? 'AKTIF' : 'PAKAI'}</button>` :
                            `<button onclick="buyItem('theme', '${id}', ${set.price})" class="px-6 py-2 bg-amber-500 hover:bg-amber-400 rounded-xl font-black text-black"><i class="fas fa-coins text-[8px]"></i> ${set.price.toLocaleString()}</button>`}
                        </div>`;
                    list.appendChild(card);
                });
            }
        };

        window.showShop = () => { renderShop('icons'); showScreen('shop'); };

        window.buyItem = async (type, id, price) => {
            const isAdmin = userData.tag === 'ADMIN';
            if (!isAdmin && (userData.coins || 0) < price) return alert("Koin tidak cukup!");
            if (!isAdmin) userData.coins -= price;
            if (type === 'skin') { if (!userData.skins) userData.skins = ["default"]; userData.skins.push(id); userData.activeSkin = id; }
            else { if (!userData.themes) userData.themes = ["default"]; userData.themes.push(id); userData.activeTheme = id; applyTheme(id); }
            await updateDoc(doc(db, 'users', userData.username), { coins: userData.coins || 0, skins: userData.skins, themes: userData.themes, activeSkin: userData.activeSkin, activeTheme: userData.activeTheme });
            updateUserUI(); renderShop(type === 'skin' ? 'icons' : 'themes');
        };

        window.equipItem = async (type, id) => {
            if (type === 'skin') userData.activeSkin = id; else { userData.activeTheme = id; applyTheme(id); }
            await updateDoc(doc(db, 'users', userData.username), { activeSkin: userData.activeSkin || "default", activeTheme: userData.activeTheme || "default" });
            updateUserUI(); renderShop(type === 'skin' ? 'icons' : 'themes');
        };

        window.goToRounds = (mode) => { gameMode = mode; showScreen('round'); };
        window.selectRounds = (num) => { selectedMaxRounds = num; if (gameMode === 'pvai') startPvAI(); else showScreen('pvpMenu'); };

        window.createRoom = async () => {
            const bet = parseInt(document.getElementById('bet-input').value) || 0;
            if (userData.tag !== 'ADMIN' && (userData.coins || 0) < bet) return alert("Koin tidak cukup!");
            const roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            currentGameId = roomId; isPlayer1 = true;
            try {
                const roomRef = doc(db, 'rooms', roomId);
                await setDoc(roomRef, { p1: currentUser.uid, p1Name: userData.username, p1Tag: userData.tag, p1Skin: userData.activeSkin, p1Theme: userData.activeTheme, p2: null, p1Choice: null, p2Choice: null, p1Score: 0, p2Score: 0, p1Ready: false, p2Ready: false, currentRound: 1, maxRounds: selectedMaxRounds, betAmount: bet, status: 'waiting', timestamp: Date.now() });
                document.getElementById('lobby-id-display').textContent = roomId;
                document.getElementById('lobby-round-info').textContent = `${selectedMaxRounds} Babak`;
                document.getElementById('lobby-bet-info').textContent = `Bet: ${bet.toLocaleString()}`;
                showScreen('waiting');
                if (gameListener) gameListener();
                gameListener = onSnapshot(roomRef, (snap) => { if (snap.exists() && snap.data().p2) joinGame(roomId, true); });
            } catch (e) { console.error(e); }
        };

        window.joinRoom = async () => {
            const roomId = document.getElementById('join-id-input').value.trim().toUpperCase(); if (!roomId) return;
            const roomRef = doc(db, 'rooms', roomId);
            try {
                const snap = await getDoc(roomRef); if (!snap.exists()) return alert("Room tidak ditemukan!");
                const data = snap.data(); if (data.p2) return alert("Penuh!");
                if (userData.tag !== 'ADMIN' && (userData.coins || 0) < data.betAmount) return alert("Koin tidak cukup!");
                await updateDoc(roomRef, { p2: currentUser.uid, p2Name: userData.username, p2Tag: userData.tag, p2Skin: userData.activeSkin, p2Theme: userData.activeTheme, status: 'playing' });
                joinGame(roomId, false);
            } catch (e) { console.error(e); }
        };

        function startPvAI() {
            gameMode = 'pvai'; isPlayer1 = true; aiState = { p1Score: 0, p2Score: 0, currentRound: 1, maxRounds: selectedMaxRounds, p1Skin: userData.activeSkin, p2Skin: "galaxy" };
            resetGameUI(); currentGameId = 'local_ai'; renderHeader(userData.username, userData.tag, "Master Bot", "PRO"); updateRoundUI(aiState); showScreen('game');
        }

        let aiState = { p1Score: 0, p2Score: 0, currentRound: 1, maxRounds: 3, p1Skin: "default", p2Skin: "galaxy" };

        window.makeChoice = async (choice) => {
            if (gameMode === 'pvp') {
                const roomRef = doc(db, 'rooms', currentGameId);
                await updateDoc(roomRef, isPlayer1 ? { p1Choice: choice } : { p2Choice: choice });
            } else { handlePvAIChoice(choice); }
            document.querySelectorAll('.btn-choice').forEach(b => { const label = b.querySelector('span:nth-child(2)').textContent.toLowerCase(); b.classList.toggle('choice-selected', label === choice); });
        };

        function handlePvAIChoice(playerChoice) {
            if (document.querySelectorAll('.btn-choice')[0].disabled) return;
            document.querySelectorAll('.btn-choice').forEach(b => b.disabled = true);
            document.getElementById('game-message').innerHTML = '<p class="text-indigo-400 animate-pulse text-white text-center">Bot sedang menganalisa...</p>';
            setTimeout(() => { const win = getWinner(playerChoice, 'batu'); if (win === 'p1') aiState.p1Score++; else if (win === 'p2') aiState.p2Score++; updateRoundUI(aiState); revealResult({ ...aiState, p1Choice: playerChoice, p2Choice: 'batu', roundWinner: win }); }, 1200);
        }

        function joinGame(gameId, isP1) { currentGameId = gameId; isPlayer1 = isP1; resetGameUI(); if (gameListener) gameListener(); gameListener = onSnapshot(doc(db, 'rooms', gameId), (snap) => { if (snap.exists()) syncPvP(snap.data()); }); showScreen('game'); }

        function syncPvP(data) {
            renderHeader(data.p1Name, data.p1Tag, data.p2Name, data.p2Tag);
            updateRoundUI(data);
            if (data.betAmount > 0) { const betDisp = document.getElementById('current-bet-display'); betDisp.textContent = `Bet: ${data.betAmount.toLocaleString()}`; betDisp.classList.remove('hidden'); }
            
            const msg = document.getElementById('game-message');
            const myChoice = isPlayer1 ? data.p1Choice : data.p2Choice;
            const enemyChoice = isPlayer1 ? data.p2Choice : data.p1Choice;
            const myReady = isPlayer1 ? data.p1Ready : data.p2Ready;
            const enemyReady = isPlayer1 ? data.p2Ready : data.p1Ready;

            if (data.p1Choice && data.p2Choice) {
                const win = getWinner(data.p1Choice, data.p2Choice);
                revealResult({ ...data, roundWinner: win });
                if (myReady && !enemyReady) { msg.innerHTML = '<div class="glass px-6 py-2 rounded-full border-amber-500/40"><p class="text-amber-400 animate-pulse uppercase text-[10px] font-black tracking-widest text-center">Menunggu lawan...</p></div>'; }
                else if (!myReady && enemyReady) { msg.innerHTML = '<div class="glass px-6 py-2 rounded-full border-indigo-500/40"><p class="text-indigo-400 uppercase text-[10px] font-black tracking-widest text-center">Lawan siap lanjut!</p></div>'; }
                if (data.p1Ready && data.p2Ready && isPlayer1) {
                    const winRound = getWinner(data.p1Choice, data.p2Choice);
                    updateDoc(doc(db, 'rooms', currentGameId), { p1Score: winRound === 'p1' ? data.p1Score + 1 : data.p1Score, p2Score: winRound === 'p2' ? data.p2Score + 1 : data.p2Score, p1Choice: null, p2Choice: null, p1Ready: false, p2Ready: false, currentRound: data.currentRound + 1 });
                }
            } else {
                if (myChoice && !enemyChoice) { msg.innerHTML = '<div class="glass px-6 py-2 rounded-full border-white/10"><p class="text-slate-400 animate-pulse uppercase text-[10px] font-black tracking-widest text-center">Lawan sedang memilih...</p></div>'; }
                else if (data.status === 'playing' && !data.p1Choice && !data.p2Choice) { resetGameUI(); }
            }
        }

        function renderHeader(n1, t1, n2, t2) {
            document.getElementById('p1-name-wrapper').innerHTML = `${getTagHtml(t1, "mb-1")}<p class="text-xs font-black uppercase text-slate-300 truncate w-full text-center text-white">${n1}${isPlayer1 ? ' (Kamu)' : ''}</p>`;
            document.getElementById('p2-name-wrapper').innerHTML = `${getTagHtml(t2, "mb-1")}<p class="text-xs font-black uppercase text-slate-300 truncate w-full text-center text-white">${n2}${!isPlayer1 ? ' (Kamu)' : ''}</p>`;
        }

        function getWinner(c1, c2) { if (c1 === c2) return 'draw'; return ((c1 === 'batu' && c2 === 'gunting') || (c1 === 'gunting' && c2 === 'kertas') || (c1 === 'kertas' && c2 === 'batu')) ? 'p1' : 'p2'; }

        function revealResult(data) {
            const s1 = SKIN_SETS[data.p1Skin || 'default']; const s2 = SKIN_SETS[data.p2Skin || 'default'];
            const d1 = document.getElementById('p1-display'); const d2 = document.getElementById('p2-display');
            const l1 = document.getElementById('p1-choice-label'); const l2 = document.getElementById('p2-choice-label');

            d1.textContent = s1[data.p1Choice]; d1.className = `w-full aspect-square max-w-[130px] bg-white/5 rounded-[3rem] flex items-center justify-center text-8xl border border-white/10 transition-all duration-500 ${s1.class}`;
            d2.textContent = s2[data.p2Choice]; d2.className = `w-full aspect-square max-w-[130px] bg-white/5 rounded-[3rem] flex items-center justify-center text-8xl border border-white/10 transition-all duration-500 ${s2.class}`;
            
            l1.textContent = data.p1Choice; l2.textContent = data.p2Choice;
            l1.className = "choice-label text-center " + (data.p1Skin === 'divine' ? 'divine-label-fix' : (data.p1Skin === 'gold' ? 'gold-label-fix' : (data.p1Skin === 'cyber' ? 'cyber-label-fix' : '')));
            l2.className = "choice-label text-center " + (data.p2Skin === 'divine' ? 'divine-label-fix' : (data.p2Skin === 'gold' ? 'gold-label-fix' : (data.p2Skin === 'cyber' ? 'cyber-label-fix' : '')));

            const msg = document.getElementById('game-message'); const won = (data.roundWinner === 'p1' && isPlayer1) || (data.roundWinner === 'p2' && !isPlayer1);
            if (data.roundWinner === 'draw') msg.innerHTML = '<span class="text-amber-400 text-4xl font-black uppercase text-center animate-bounce">Seri!</span>';
            else msg.innerHTML = `<span class="${won ? 'text-indigo-400' : 'text-purple-400'} text-5xl font-black uppercase scale-110 transition-all text-center text-white drop-shadow-xl">${won ? 'MENANG!' : 'KALAH!'}</span>`;
            document.getElementById('game-controls').classList.add('hidden'); document.getElementById('game-actions').classList.remove('hidden');
            if (data.currentRound >= data.maxRounds) handleFinalWinner(data);
            else { document.getElementById('next-round-btn').classList.remove('hidden'); document.getElementById('final-rematch-btn').classList.add('hidden'); }
        }

        async function handleFinalWinner(data) {
            document.getElementById('next-round-btn').classList.add('hidden'); document.getElementById('final-rematch-btn').classList.remove('hidden');
            const isWinner = (data.p1Score > data.p2Score && isPlayer1) || (data.p2Score > data.p1Score && !isPlayer1);
            const isDraw = data.p1Score === data.p2Score; let coinMsg = "";
            if (userData.tag === 'ADMIN') coinMsg = "ADMIN STATUS: UNLIMITED POWER";
            else if (gameMode === 'pvai' && isWinner) { coinMsg = "+50 Koin!"; await updateCoins(50); }
            else if (gameMode === 'pvp' && data.betAmount > 0 && !isDraw) {
                if (isWinner) { coinMsg = `+${data.betAmount.toLocaleString()} Koin!`; await updateCoins(data.betAmount); }
                else { coinMsg = `-${data.betAmount.toLocaleString()} Koin!`; await updateCoins(-data.betAmount); }
            }
            document.getElementById('game-message').innerHTML = `<div class="text-center p-4 text-white"><p class="text-[10px] font-black uppercase text-slate-500 mb-1">Pertempuran Selesai</p><p class="text-6xl font-black ${isWinner ? 'text-amber-400' : (isDraw ? 'text-white/60' : 'text-red-500')} uppercase italic drop-shadow-xl text-center text-white">${isWinner ? 'JUARA!' : (isDraw ? 'SERI!' : 'KALAH!')}</p><p class="text-sm font-black text-amber-500 mt-3 text-center text-white">${coinMsg}</p></div>`;
        }

        async function updateCoins(amount) { if (userData.tag === 'ADMIN') return; userData.coins = (userData.coins || 0) + amount; await updateDoc(doc(db, 'users', userData.username), { coins: userData.coins }); updateUserUI(); }

        document.getElementById('next-round-btn').addEventListener('click', async () => {
            if (gameMode === 'pvp') {
                const roomRef = doc(db, 'rooms', currentGameId);
                await updateDoc(roomRef, isPlayer1 ? { p1Ready: true } : { p2Ready: true });
            } else { aiState.currentRound++; resetGameUI(); updateRoundUI(aiState); }
        });

        document.getElementById('final-rematch-btn').addEventListener('click', async () => {
            if (gameMode === 'pvp') { await updateDoc(doc(db, 'rooms', currentGameId), { p1Score: 0, p2Score: 0, p1Choice: null, p2Choice: null, p1Ready: false, p2Ready: false, currentRound: 1, status: 'playing' }); }
            else { startPvAI(); }
        });

        function updateRoundUI(data) { document.getElementById('p1-score').textContent = data.p1Score; document.getElementById('p2-score').textContent = data.p2Score; document.getElementById('current-round-display').textContent = `${data.currentRound} / ${data.maxRounds}`; }

        function resetGameUI() {
            const skin = SKIN_SETS[userData.activeSkin || 'default'];
            document.getElementById('current-bet-display').classList.add('hidden');
            document.getElementById('p1-display').innerHTML = '<i class="fas fa-question text-white/5"></i>';
            document.getElementById('p1-display').className = `w-full aspect-square max-w-[130px] bg-white/5 rounded-[3rem] flex items-center justify-center text-8xl border border-white/10 transition-all duration-500 ${skin.class}`;
            document.getElementById('p2-display').innerHTML = '<i class="fas fa-question text-white/5"></i>';
            document.getElementById('p2-display').className = 'w-full aspect-square max-w-[130px] bg-white/5 rounded-[3rem] flex items-center justify-center text-8xl border border-white/10 transition-all';
            document.getElementById('p1-choice-label').textContent = ''; document.getElementById('p2-choice-label').textContent = '';
            document.getElementById('game-message').innerHTML = '<p class="text-slate-500 uppercase text-xs tracking-widest font-black text-center text-white">Menentukan Serangan...</p>';
            document.getElementById('game-controls').classList.remove('hidden'); document.getElementById('game-actions').classList.add('hidden');
            document.querySelectorAll('.btn-choice').forEach(b => { b.classList.remove('choice-selected'); b.disabled = false; });
            applySkinToControls();
        }

        document.getElementById('quit-btn').addEventListener('click', () => { if (gameListener) gameListener(); showScreen('mode'); });
        document.getElementById('cancel-room-btn').addEventListener('click', async () => { if (gameListener) gameListener(); if (currentGameId && isPlayer1) await deleteDoc(doc(db, 'rooms', currentGameId)); showScreen('pvpMenu'); });
    </script>
</body>
</html>